#!/bin/bash

# Jenkins Configuration Summary Report
# Description: Complete summary of Jenkins Master and Spot Workers configuration

echo "ğŸ“‹ JENKINS CONFIGURATION SUMMARY REPORT"
echo "========================================"
echo ""

# Get Grafana IP
GRAFANA_IP=$(kubectl get svc grafana -n observability-stack -o jsonpath='{.status.loadBalancer.ingress[0].ip}' 2>/dev/null || echo "GRAFANA_IP_NOT_FOUND")

echo "ğŸ¯ QUICK SUMMARY FROM LIVE EXTRACTION:"
echo ""

echo "ğŸ‘‘ JENKINS MASTER CONFIGURATION:"
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
echo "â€¢ JVM Memory: -Xms512m -Xmx1536m (512MB-1.5GB)"
echo "â€¢ JVM Options: UseG1GC, headless mode"
echo "â€¢ Resource Limits: 1 CPU, 2Gi Memory"
echo "â€¢ Resource Requests: 300m CPU, 512Mi Memory"
echo "â€¢ Port: 8080 (HTTP), 50000 (Agent)"
echo "â€¢ Configuration: JCasC (Configuration as Code)"
echo ""

echo "ğŸ”Œ INSTALLED PLUGINS:"
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
echo "â€¢ kubernetes - For spot workers"
echo "â€¢ workflow-aggregator - Pipeline support"
echo "â€¢ git - Source control"
echo "â€¢ configuration-as-code - JCasC"
echo "â€¢ build-timeout - Timeout management"
echo "â€¢ credentials-binding - Secure credentials"
echo "â€¢ timestamper - Log timestamps"
echo ""

echo "â˜ï¸  CLOUD CONFIGURATION:"
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
echo "â€¢ Cloud Provider: kubernetes"
echo "â€¢ Namespace: jenkins-master"
echo "â€¢ Container Capacity: 10 concurrent"
echo "â€¢ Connect Timeout: 5s"
echo "â€¢ Read Timeout: 15s"
echo "â€¢ Jenkins URL: http://jenkins-master.jenkins-master.svc.cluster.local:8080"
echo "â€¢ Agent Tunnel: jenkins-master-agent.jenkins-master.svc.cluster.local:50000"
echo ""

echo "ğŸ¯ SPOT WORKERS STATUS:"
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
echo "â€¢ Current Running Workers: $(kubectl get pods -n jenkins-workers 2>/dev/null | grep -c Running || echo "0")"
echo "â€¢ Spot Node: aks-spot-33804603-vmss000000"
echo "â€¢ Worker Image: jenkins/inbound-agent:latest"
echo "â€¢ Recent Activity: $(kubectl get events -n jenkins-workers --sort-by=.metadata.creationTimestamp 2>/dev/null | tail -1 | awk '{print $1" "$2" "$3}' || echo "No recent events")"
echo ""

echo "ğŸ“Š CURRENT RESOURCE USAGE:"
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
kubectl top pods -n jenkins-master 2>/dev/null || echo "â€¢ Metrics server not available"
echo ""

echo "ğŸ”— ACCESS INFORMATION:"
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
JENKINS_IP=$(kubectl get svc jenkins-master -n jenkins-master -o jsonpath='{.status.loadBalancer.ingress[0].ip}' 2>/dev/null || echo "JENKINS_IP_NOT_FOUND")
echo "â€¢ Jenkins Master: http://$JENKINS_IP"
echo "â€¢ Grafana Dashboard: http://$GRAFANA_IP"
echo "â€¢ Grafana Login: admin / admin123"
echo ""

echo "ğŸ” RECOMMENDED LOKI QUERIES FOR DETAILED ANALYSIS:"
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
echo ""
echo "ğŸ“‹ Master Configuration:"
echo "   {kubernetes_namespace_name=\"jenkins-master\"} |= \"JAVA_OPTS\" or \"plugin\" or \"config\""
echo ""
echo "ğŸ¯ Spot Workers Execution:"
echo "   {kubernetes_namespace_name=\"jenkins-workers\"} |= \"Build\" or \"Running\" or \"spot\""
echo ""
echo "âš ï¸  System Errors:"
echo "   {job=\"fluent-bit\"} |= \"jenkins\" |= \"ERROR\" or \"FAILED\""
echo ""
echo "ğŸ“ˆ Performance Analysis:"
echo "   {job=\"fluent-bit\"} |= \"jenkins\" |= \"memory\" or \"cpu\" or \"duration\""
echo ""

echo "ğŸ’¡ WHAT YOU'VE LEARNED:"
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
echo "âœ… Jenkins Master is using G1 Garbage Collector with 1.5GB max heap"
echo "âœ… 7 essential plugins are installed for Kubernetes spot workers"
echo "âœ… Cloud configuration supports 10 concurrent workers on Kubernetes"
echo "âœ… Spot workers are running on dedicated spot node: aks-spot-33804603-vmss000000"
echo "âœ… Configuration as Code (JCasC) is enabled for infrastructure as code"
echo "âœ… Security realm configured with local users (admin access)"
echo "âœ… Complete observability stack with Loki + Grafana is operational"
echo ""

echo "ğŸš€ NEXT STEPS FOR DETAILED ANALYSIS:"
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
echo "1. Run: ./queries/08_master_config_analysis.sh - For detailed master analysis"
echo "2. Run: ./queries/09_spot_execution_analysis.sh - For spot workers deep dive"
echo "3. Run: ./queries/10_complete_system_analysis.sh - For full system overview"
echo "4. Access Grafana: http://$GRAFANA_IP/explore - For real-time log analysis"
echo ""

echo "ğŸ“‹ CONFIGURATION FILES TO REVIEW:"
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
echo "â€¢ JCasC Config: kubectl get cm jenkins-master-jenkins-jcasc-config -n jenkins-master -o yaml"
echo "â€¢ Plugins List: kubectl get cm jenkins-master -n jenkins-master -o yaml"
echo "â€¢ Helm Values: ./helm/jenkins_helm_values.yaml"
echo "â€¢ Spot Cloud Config: ./jenkins_scripts/jenkins_spot_cloud.groovy"
